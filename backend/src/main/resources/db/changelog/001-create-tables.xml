<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- 用户表 -->
    <changeSet id="001-create-users-table" author="poker-system">
        <createTable tableName="users">
            <column name="id" type="BIGSERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password_hash" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="avatar_url" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex tableName="users" indexName="idx_users_username">
            <column name="username"/>
        </createIndex>
        
        <createIndex tableName="users" indexName="idx_users_email">
            <column name="email"/>
        </createIndex>
    </changeSet>

    <!-- 俱乐部表 -->
    <changeSet id="002-create-clubs-table" author="poker-system">
        <createTable tableName="clubs">
            <column name="id" type="BIGSERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="avatar_url" type="VARCHAR(255)"/>
            <column name="creator_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="settings" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint
                baseTableName="clubs"
                baseColumnNames="creator_id"
                constraintName="fk_clubs_creator"
                referencedTableName="users"
                referencedColumnNames="id"/>
                
        <createIndex tableName="clubs" indexName="idx_clubs_creator">
            <column name="creator_id"/>
        </createIndex>
    </changeSet>

    <!-- 俱乐部成员表 -->
    <changeSet id="003-create-club-members-table" author="poker-system">
        <createTable tableName="club_members">
            <column name="id" type="BIGSERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="club_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
            <column name="joined_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint
                baseTableName="club_members"
                baseColumnNames="club_id"
                constraintName="fk_club_members_club"
                referencedTableName="clubs"
                referencedColumnNames="id"/>
                
        <addForeignKeyConstraint
                baseTableName="club_members"
                baseColumnNames="user_id"
                constraintName="fk_club_members_user"
                referencedTableName="users"
                referencedColumnNames="id"/>
        
        <addUniqueConstraint tableName="club_members" columnNames="club_id, user_id" constraintName="uk_club_members_club_user"/>
        
        <createIndex tableName="club_members" indexName="idx_club_members_club">
            <column name="club_id"/>
        </createIndex>
        
        <createIndex tableName="club_members" indexName="idx_club_members_user">
            <column name="user_id"/>
        </createIndex>
    </changeSet>


    <!-- 房间表 -->
    <changeSet id="005-create-rooms-table" author="poker-system">
        <createTable tableName="rooms">
            <column name="id" type="BIGSERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="room_code" type="VARCHAR(8)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="club_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="small_blind" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="big_blind" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="default_chips" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="min_buyin" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="max_buyin" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="max_seats" type="INTEGER" defaultValue="9">
                <constraints nullable="false"/>
            </column>
            <column name="duration_minutes" type="INTEGER"/>
            <column name="action_time_seconds" type="INTEGER" defaultValue="30">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="WAITING">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP"/>
            <column name="ended_at" type="TIMESTAMP"/>
        </createTable>
        
        <addForeignKeyConstraint
                baseTableName="rooms"
                baseColumnNames="club_id"
                constraintName="fk_rooms_club"
                referencedTableName="clubs"
                referencedColumnNames="id"/>
                
        <addForeignKeyConstraint
                baseTableName="rooms"
                baseColumnNames="created_by"
                constraintName="fk_rooms_creator"
                referencedTableName="users"
                referencedColumnNames="id"/>
                
        <createIndex tableName="rooms" indexName="idx_rooms_room_code">
            <column name="room_code"/>
        </createIndex>
        
        <createIndex tableName="rooms" indexName="idx_rooms_club">
            <column name="club_id"/>
        </createIndex>
        
        <createIndex tableName="rooms" indexName="idx_rooms_status">
            <column name="status"/>
        </createIndex>
        
        <createIndex tableName="rooms" indexName="idx_rooms_creator">
            <column name="created_by"/>
        </createIndex>
    </changeSet>


</databaseChangeLog>
